/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/dijit/analysis/AnalysisBase",["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/has","dojo/i18n","dojo/json","dojo/Deferred","dojo/promise/all","dojo/data/ItemFileWriteStore","dojo/string","esri/kernel","esri/lang","esri/request","esri/tasks/Geoprocessor","esri/dijit/analysis/utils","esri/IdentityManager"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){var _12=_2(null,{declaredClass:"esri.dijit.analysis.AnalysisBase",isOutputLayerItemUpdated:false,analysisGpServer:null,toolName:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,_counter:null,constructor:function(){this.isOutputLayerItemUpdated=false;this._rids=[];this._counter=0;},postMixInProperties:function(){this.inherited(arguments);this.i18n={};_3.mixin(this.i18n,_7.getLocalization("esri","jsapi").common);_3.mixin(this.i18n,_7.getLocalization("esri","jsapi").analysisTools);_3.mixin(this.i18n,_7.getLocalization("esri","jsapi").analysisMsgCodes);},execute:function(_13){this.jobParams=_13.jobParams;if(!this.jobParams.OutputName){this.itemParams=null;}else{this.itemParams=_13.itemParams;}this._checkUser();},_checkUser:function(){_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_14){var _15,_16,_17,_18;_15=_14.userId;_16=_d.id.findServerInfo(this._toolServiceUrl);_17=_16.owningSystemUrl;if(_15){_18=_17+"/sharing/community/users/"+_15;_f({url:_18,"content":{token:_14.token,f:"json"}}).then(_3.hitch(this,this._handleUserProfileResponse),function(_19){this.onJobFailed({message:"error getting user response",jobParams:this.jobParams});});}}),function(_1a){});},_handleUserProfileResponse:function(_1b){if(!_1b.accountId){this.onJobFailed({message:this.i18n.orgUsrMsg,jobParams:this.jobParams});return;}if(_1b.role==="account_admin"||_1b.role==="account_publisher"||_1b.role==="org_admin"||_1b.role==="org_publisher"){if(this.itemParams){this._checkServiceName(_1b.accountId);}else{this._submitGpJob();this.onExecute(this.jobParams);}}else{this.onJobFailed({message:this.i18n.pubRoleMsg,messageCode:"AB_0001",jobParams:this.jobParams});return;}},_checkServiceName:function(_1c){var _1d,_1e,_1f,url,_20,_21;_1d=_d.id.findServerInfo(this._toolServiceUrl);_1e=_1d.owningSystemUrl;_1f=_d.id.findCredential(this._toolServiceUrl);url=_1e+"/sharing/portals/"+_1c+"/isServiceNameAvailable";_20=_5.fromJson(this.jobParams.OutputName);_21={name:_20.serviceProperties.name,type:"Feature Service",token:_1f.token,f:"json"};_f({"url":url,"content":_21}).then(_3.hitch(this,function(_22){if(_22.available){this._createService();this.onExecute(this.jobParams);}else{this.onJobFailed({message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002",jobParams:this.jobParams});}}),_3.hitch(this,function(_23){this.onJobFailed({message:"error getting service name checked",jobParams:this.jobParams});}));},_createService:function(){_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_24){var _25,_26,_27,_28,_29,url,_2a;_25=_24.userId;_26=_d.id.findServerInfo(this._toolServiceUrl);_27=_26.owningSystemUrl;_28=_5.fromJson(this.jobParams.OutputName);if(_25){_2a=this.itemParams.folder;url=_27+"/sharing/content/users/"+_25+(_2a&&_2a!=="/"?("/"+_2a):"")+"/createService";_29={"createParameters":_5.toJson({"currentVersion":10.2,"serviceDescription":"","hasVersionedData":false,"supportsDisconnectedEditing":false,"hasStaticData":true,"maxRecordCount":2000,"supportedQueryFormats":"JSON","capabilities":"Query","description":"","copyrightText":"","allowGeometryUpdates":false,"units":"esriMeters","syncEnabled":false,"editorTrackingInfo":{"enableEditorTracking":false,"enableOwnershipAccessControl":false,"allowOthersToUpdate":true,"allowOthersToDelete":true},"xssPreventionInfo":{"xssPreventionEnabled":true,"xssPreventionRule":"InputOnly","xssInputRule":"rejectInvalid"},"tables":[],"name":_28.serviceProperties.name}),"outputType":"featureService",f:"json"};_f({"url":url,"content":_29},{"usePost":true}).then(_3.hitch(this,this._submitGpJob),_3.hitch(this,this._handleCreateServiceError));}}),function(_2b){});},_handleCreateServiceError:function(_2c){this.onJobFailed({message:_2c.message,jobParams:this.jobParams});},_submitGpJob:function(_2d){var _2e;if(this.itemParams){this.currentGpItemId=_2d.itemId;_2e=_5.fromJson(this.jobParams.OutputName);_2e.itemProperties={itemId:_2d.itemId};this.jobParams.OutputName=_5.toJson(_2e);}this.gp.setUpdateDelay(3000);this.gp.submitJob(this.jobParams,_3.hitch(this,this._gpJobComplete),_3.hitch(this,this._gpJobStatus),_3.hitch(this,this._gpJobFailed));this.onJobSubmit(this.jobParams);},_updateItem:function(){var _2f,_30,_31,_32,_33,url,_34,_35,_36,_37,def;_2f=_d.id.findServerInfo(this._toolServiceUrl);_30=_2f.owningSystemUrl;_31=_d.id.findCredential(this._toolServiceUrl);_32=_31.userId;if(_32){_33=this.itemParams.folder;url=_30+"/sharing/content/users/"+_32+(_33&&_33!=="/"?("/"+_33):"")+"/items/"+this.currentGpItemId+"/update";this.itemParams.typeKeywords="jobUrl:"+this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId;_34=_3.mixin({f:"json"},this.itemParams);_35={};_37={};for(_36 in this.jobParams){if(this.jobParams.hasOwnProperty(_36)){if(typeof this.jobParams[_36]==="string"&&(this.jobParams[_36].search(/[\{\}\[\]]/g)!==-1)){_37[_36]=_5.fromJson(this.jobParams[_36]);}else{_37[_36]=this.jobParams[_36];}}}_35.analysisInfo={toolName:this.toolName,jobParams:_37};if(this._popupInfo){_35.layers=[{"id":0,"popupInfo":this._popupInfo}];}_34.text=_5.toJson(_35);def=_f({"url":url,"content":_34},{"usePost":true});def.then(_3.hitch(this,this._handleItemUpdate),_3.hitch(this,this._handleUpdateItemError));return def;}},_handleItemUpdate:function(_38){this.isOutputLayerItemUpdated=true;},_handleItemDataUpdate:function(_39){},_handleUpdateItemError:function(_3a){this.isOutputLayerItemUpdated=true;},_handleErrorResponse:function(msg){this.onJobFailed(msg);},_refreshItem:function(){_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_3b){var _3c,_3d,_3e,_3f,url;_3c=_3b.userId;_3d=_d.id.findServerInfo(this._toolServiceUrl);_3e=_3d.owningSystemUrl;if(_3c){_3f=this.itemParams.folder;url=_3e+"/sharing/content/users/"+_3c+(_3f&&_3f!=="/"?("/"+_3f):"")+"/items/"+this.currentGpItemId+"/refresh";return _f({"url":url,"content":{f:"json"}},{"usePost":true});}}),function(_40){});},_handleItemRefresh:function(_41){},_gpJobStatus:function(_42){var msg="",_43=[],_44,_45="",str;_42.jobParams=this.jobParams;if(_42.jobStatus==="esriJobFailed"){if(_42.message){msg=_42.message;}else{if(_42.messages){_43=_4.filter(_42.messages,function(_46){if(_46.type==="esriJobMessageTypeError"&&_46.description&&_46.description.indexOf("messageCode")!==-1){return _46.description;}});if(_43.length>0){_4.forEach(_43,function(_47){_44=_5.fromJson(_47.description);str="";if(_44.messageCode){str=_e.isDefined(this.i18n[_44.messageCode])?this.i18n[_44.messageCode]:_44.message;str=_e.isDefined(_44.params)?_c.substitute(str,_44.params):str;msg+=str;}else{if(_44.error&&_44.error.messageCode){str=_e.isDefined(this.i18n[_44.messageCode])?this.i18n[_44.messageCode]:_44.message;str=_e.isDefined(_44.params)?_c.substitute(str,_44.params):str;msg+=str;}}},this);}}}_42.message=msg;}this.onJobStatus(_42);this._jobInfo=_42;if(this.itemParams&&!this.isOutputLayerItemUpdated){this._updateItem();}_45="";switch(_42.jobStatus){case "esriJobSubmitted":_45="Submitted...";break;case "esriJobExecuting":_45="Executing...";break;case "esriJobSucceeded":break;}},_updateRefreshItem:function(_48){var _49=[];_49.push(this._refreshItem());_49.push(this._updateItem());_a(_49).then(_3.hitch(this,function(_4a){_48.outputLayerName=_5.fromJson(this.jobParams.OutputName).serviceProperties.name;(_48.value).itemId=this.currentGpItemId;_48.analysisInfo={toolName:this.toolName,jobParams:this.jobParams};this.onJobResult(_48);}),_3.hitch(this,this._handleDeleteItemError));},_gpJobComplete:function(_4b){if(_4b.jobStatus!=="esriJobFailed"){_4b.jobParams=this.jobParams;this.onJobSuccess(_4b);this.gp.getResultData(_4b.jobId,this.resultParameter).then(_3.hitch(this,function(_4c){if((_4c.value.featureSet&&!_4c.value.url)||!this.itemParams){if(this.jobParams.isProcessInfo){this.gp.getResultData(_4b.jobId,"ProcessInfo").then(_3.hitch(this,function(_4d){var _4e=[];_4.forEach(_4d.value,function(_4f){_4e.push(dojo.fromJson(_4f));},this);_4c.analysisReport=_11.buildReport(_4e);this.onJobResult(_4c);}));}else{this.onJobResult(_4c);}}else{if(!_4c.value.url){_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_50){var _51,_52,_53,_54,url;_51=_50.userId;_52=_d.id.findServerInfo(this._toolServiceUrl);_53=_52.owningSystemUrl;if(_51){_54=this.itemParams.folder;url=_53+"/sharing/content/users/"+_51+(_54&&_54!=="/"?("/"+_54):"")+"/items/"+this.currentGpItemId+"/delete";_f({"url":url,"content":{f:"json"}},{"usePost":true}).then(_3.hitch(this,this._handleItemDelete),_3.hitch(this,this._handleDeleteItemError));}}),function(_55){});this.onJobFailed({message:this.i18n.emptyResultInfoMsg,type:"warning",jobParams:this.jobParams});}else{var _56,_57,_58,_59;_56=_4c.value.url.replace("/rest/","/admin/").replace("/FeatureServer/0",".FeatureServer")+"/updateDefinition";_57={"capabilities":"Query","hasStaticData":true,"editorTrackingInfo":{"enableEditorTracking":false,"enableOwnershipAccessControl":false,"allowOthersToUpdate":true,"allowOthersToDelete":true}};_58={usePost:true};_59={updateDefinition:_8.stringify(_57),f:"json"};_f({"url":_56,"content":_59},_58).then(_3.hitch(this,function(_5a){if(_5a.success===true){if(_4c.value.layerInfo&&_4c.value.layerInfo.popupInfo){this._popupInfo=_4c.value.layerInfo.popupInfo;}if(this.jobParams.isProcessInfo){this.gp.getResultData(_4b.jobId,"ProcessInfo").then(_3.hitch(this,function(_5b){var _5c=[];_4.forEach(_5b.value,function(_5d){_5c.push(dojo.fromJson(_5d));},this);this.itemParams.description=_11.buildReport(_5c);this._updateRefreshItem(_4c);}));}else{this._updateRefreshItem(_4c);}}else{this.onJobFailed({message:"",jobParams:this.jobParams});}}),_3.hitch(this,this._handleCreateServiceError));}}}));}},_gpJobFailed:function(_5e){var _5f=_3.clone(_5e),msg="",_60=[],_61,str;_5f.jobParams=this.jobParams;if(_5e.message){msg=_5e.message;}else{if(_5e.messages){_60=_4.filter(_5e.messages,function(_62){if(_62.type==="esriJobMessageTypeError"&&_62.description&&_62.description.indexOf("messageCode")!==-1){return _62.description;}});if(_60.length>0){_4.forEach(_60,function(_63){_61=_5.fromJson(_63.description);str="";if(_61.messageCode){str=_e.isDefined(this.i18n[_61.messageCode])?this.i18n[_61.messageCode]:_61.message;str=_e.isDefined(_61.params)?_c.substitute(str,_61.params):str;msg+=str;}else{if(_61.error&&_61.error.messageCode){str=_e.isDefined(this.i18n[_61.messageCode])?this.i18n[_61.messageCode]:_61.message;str=_e.isDefined(_61.params)?_c.substitute(str,_61.params):str;msg+=str;}}},this);}}}_5e.message=msg;this.onJobFailed(_5e);},cancel:function(_64){this.gp.cancelJob(_64.jobId).then(_3.hitch(this,function(_65){if(_65.jobStatus==="esriJobCancelled"){_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_66){var _67,_68,_69,_6a,url;_67=_66.userId;_68=_d.id.findServerInfo(this._toolServiceUrl);_69=_68.owningSystemUrl;if(_67){_6a=this.itemParams.folder;url=_69+"/sharing/content/users/"+_67+(_6a&&_6a!=="/"?("/"+_6a):"")+"/items/"+this.currentGpItemId+"/delete";_f({"url":url,"content":{f:"json"}},{"usePost":true}).then(_3.hitch(this,this._handleItemDelete),_3.hitch(this,this._handleDeleteItemError));}}),function(_6b){});}}),function(_6c){});},_handleItemDelete:function(_6d){this.onJobCancel(_6d);},_handleDeleteItemError:function(_6e){this.onJobFailed(_6e);},_initFolderStore:function(_6f,def){this.portal=new _6f.Portal(this._portalUrl);this.portal.signIn().then(_3.hitch(this,function(_70){this.portalUser=_70;this.portalUser.getFolders().then(_3.hitch(this,function(_71){var _72=new _b({data:{identifier:"id",label:"name",items:[]}});_72.newItem({name:this.portalUser.username,id:""});_4.forEach(_71,function(_73){_72.newItem({name:_73.title,id:_73.id});});def.resolve(_72);}));}));},getFolderStore:function(){var def=new _9();_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_74){var _75,_76,_77;_75=_74.userId;_76=_d.id.findServerInfo(this._toolServiceUrl);_77=_76.owningSystemUrl;this._portalUrl=_77;var _78=["esri/arcgis/Portal"],rid=this._counter++,_79=this;if(this._rids){this._rids.push(rid);}_1(_78,function(_7a){var idx=_79._rids?_4.indexOf(_79._rids,rid):-1;if(idx!==-1){_79._rids.splice(idx,1);_79._initFolderStore(_7a,def);}});}));return def;},getCreditsEstimate:function(_7b,_7c){var url,def,_7d;url=this._toolServiceUrl.replace("/"+_7b,"/exts/Estimate/"+_7b);def=new _9();_d.id.getCredential(this._toolServiceUrl).then(_3.hitch(this,function(_7e){_7d=_3.mixin({f:"json",token:_7e.token},_7c);_f({"url":url,"content":_7d},{"usePost":true}).then(function(_7f){def.resolve(_7f);},function(_80){console.log("error getting estimate",_80);def.resolve(_80);});}),function(_81){def.reject(_81);});return def;},_setToolServiceUrlAttr:function(_82){this._toolServiceUrl=_82;var _83=new esri.ServerInfo();this.gp=new _10(this._toolServiceUrl);},onExecute:function(_84){},onJobSubmit:function(_85){},onJobStatus:function(_86){},onJobSuccess:function(_87){},onJobResult:function(_88){},onJobFailed:function(_89){},onJobComplete:function(_8a){},onJobCancel:function(_8b){},onSave:function(){},onClose:function(){}});if(_6("extend-esri")){_3.setObject("dijit.analysis.AnalysisBase",_12,_d);}return _12;});